cscope 15 $HOME/test/Libsession_Bentchmark -q 0000000145 0000005853
	@main.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<±h»ad.h
>

5 
	~<lim™s.h
>

6 
	~"£ssiÚ.h
"

8 
	#MYSQL_USERNAME
 "kpf"

	)

9 
	#MYSQL_PASSWD
 "qw”1234"

	)

10 
	#MYSQL_PORT
 3456

	)

11 
	#SESSION_TIMEOUT
 10

	)

13 
	sglob®_¬gs_s
 {

14 
	m´oûss
;

15 
	mth»ads
;

16 
	mš‹rv®
;

17 
	mtimes
;

18 
	mho¡
[
SESSION_IP_MAXLEN
];

19 
	mlog
[
PATH_MAX
];

20 } 
	tglob®_¬gs_t
;

22 
glob®_¬gs_t
 
	gg_¬gs
;

24 
	sglob®_v¬s_s
 {

25 
±h»ad_mu‹x_t
 
	mmu‹x
;

26 
±h»ad_mu‹x_t
 
	mmu‹x_maš
;

27 
±h»ad_cÚd_t
 
	mcÚd
;

28 
±h»ad_cÚd_t
 
	mcÚd_maš
;

29 
	mth»ads_¡¬‹d
;

30 } 
	tglob®_v¬s_t
;

32 
glob®_v¬s_t
 
	gg_v¬s
;

34 *
	$£¬ch_upd©e_£ssiÚ
(*
¬g
)

36 
»t
 = 0, 
loİ
 = 0;

37 
£ssiÚ_hªdË
 
hªdË
;

38 
£ssiÚ_cfg_t
 
cfg
;

39 
£ssiÚ_t
 
£s
;

40 
time_t
 
tm_Şd
, 
tm_Ãw
;

42 
	`¡ºıy
(
cfg
.
ho¡
, "loÿlho¡", 
SESSION_IP_MAXLEN
);

43 
cfg
.
pÜt
 = 
MYSQL_PORT
;

44 
	`¡ºıy
(
cfg
.
u£ºame
, 
MYSQL_USERNAME
, 
SESSION_ID_MAXLEN
);

45 
	`¡ºıy
(
cfg
.
·sswÜd
, 
MYSQL_PASSWD
, 
SESSION_PWD_MAXLEN
);

46 
»t
 = 
	`£ssiÚ_š™
(&
hªdË
, &
cfg
, 
SESSION_TIMEOUT
, 
ALG_SHA1
);

47 ià(
»t
 != 0) {

48 
	`DEBUG
(
LOG_ERR
, "£ssiÚ_š™ faed,„‘<0x%x>\n", 
»t
);

52 
	`mem£t
(&
£s
, 0, (ses));

53 
£s
.
uid
 = 
	`±h»ad_£lf
();

54 
	`¢´štf
(
£s
.
®Ÿs
, 
SESSION_ID_MAXLEN
, "T_%u", ses.
uid
);

55 
	`årštf
(
¡d”r
, "th»ad<%u> s¹ed\n", 
£s
.
uid
);

57 
»t
 = 
	`£ssiÚ_add
(
hªdË
, &
£s
);

58 ià(
»t
 != 0) {

59 
	`årštf
(
¡d”r
, "£ssiÚ_add faed,„‘<0x%x>\n", 
»t
);

63 
	`±h»ad_mu‹x_lock
(&
g_v¬s
.
mu‹x
);

64 
g_v¬s
.
th»ads_¡¬‹d
++;

65 ià(
g_v¬s
.
th»ads_¡¬‹d
 >ğ
g_¬gs
.
th»ads
) {

66 
	`±h»ad_cÚd_sigÇl
(&
g_v¬s
.
cÚd_maš
);

68 
	`±h»ad_cÚd_wa™
(&
g_v¬s
.
cÚd
, &g_v¬s.
mu‹x
);

69 
	`±h»ad_mu‹x_uÆock
(&
g_v¬s
.
mu‹x
);

71 
loİ
 = 1;†oop < 100000;†oop++) {

72 
	`time
(&
tm_Şd
);

73 
£s
.
Ï¡_time
 = 
tm_Şd
;

74 
»t
 = 
	`£ssiÚ_qu”y
(
hªdË
, &
£s
, 
SESSION_QUERY_BY_SID
);

75 ià(
»t
 != 0) {

76 
	`årštf
(
¡d”r
, "£ssiÚ_qu”y faed,„‘<0x%x>\n", 
»t
);

79 
»t
 = 
	`£ssiÚ_upd©e
(
hªdË
, &
£s
, 
SESSION_UPDATE_LAST_TIME
);

80 ià(
»t
 != 0) {

81 
	`årštf
(
¡d”r
, "£ssiÚ_upd©çed,„‘<0x%x>\n", 
»t
);

84 
	`time
(&
tm_Ãw
);

85 ià(
tm_Ãw
 - 
tm_Şd
 > 1 ) {

86 
	`årštf
(
¡d”r
, "qu”y_upd©u£d<%d> secÚds\n", 
tm_Ãw
 - 
tm_Şd
);

89 
ex™_ş—n
:

90 
	`£ssiÚ_d–‘e
(
hªdË
, 
£s
.
sid
);

91 
ex™_dœty
:

92 
	`£ssiÚ_ex™
(
hªdË
);

93 
ex™_rude
:

94 
	`årštf
(
¡d”r
, "th»ad<%u>ƒx™\n", 
	`±h»ad_£lf
());

95 
	`±h»ad_ex™
(
NULL
);

96 
	}
}

98 
	$·r£_¬gs
(
¬gc
, *
¬gv
[])

100 
g_¬gs
.
th»ads
 = 20;

101 
	}
}

103 
	$chd_´oûss
()

105 
th»ads
 = 0;

106 
±h»ad_t
 
tid
;

107 
±h»ad_©Œ_t
 
©Œ
;

109 
	`±h»ad_©Œ_š™
(&
©Œ
);

110 
	`±h»ad_©Œ_£td‘ach¡©e
(&
©Œ
, 
PTHREAD_CREATE_DETACHED
);

112 
	`±h»ad_mu‹x_š™
(&
g_v¬s
.
mu‹x
, 
NULL
);

113 
	`±h»ad_cÚd_š™
(&
g_v¬s
.
cÚd
, 
NULL
);

114 
	`±h»ad_mu‹x_š™
(&
g_v¬s
.
mu‹x_maš
, 
NULL
);

115 
	`±h»ad_cÚd_š™
(&
g_v¬s
.
cÚd_maš
, 
NULL
);

117 
th»ads
 = 0;h»ad < 
g_¬gs
.threads;hreads++) {

118 
	`±h»ad_ü—‹
(&
tid
, &
©Œ
, 
£¬ch_upd©e_£ssiÚ
, 
NULL
);

122 
	`±h»ad_mu‹x_lock
(&
g_v¬s
.
mu‹x_maš
);

123 
	`±h»ad_cÚd_wa™
(&
g_v¬s
.
cÚd_maš
, &g_v¬s.
mu‹x_maš
);

124 
	`±h»ad_mu‹x_uÆock
(&
g_v¬s
.
mu‹x_maš
);

125 
	`±h»ad_cÚd_brßdÿ¡
(&
g_v¬s
.
cÚd
);

126 
	`·u£
();

128 
	`şo£_log
();

130 
	}
}

132 
	$maš
(
¬gc
, *
¬gv
[])

134 
th»ads
 = 0;

138 
	`İ’_log
(
g_¬gs
.
log
);

139 
	`£t_log_Ëv–
(0);

140 
	`·r£_¬gs
(
¬gc
, 
¬gv
);

141 
	`chd_´oûss
();

143 
	}
}

	@session.h

10 #iâdeà
KBM_SESSION_H


11 
	#KBM_SESSION_H


	)

13 
	~<Ãtš‘/š.h
>

16 
	#SESSION_IP_MAXLEN
 
INET6_ADDRSTRLEN


	)

17 
	#SESSION_SKEY_MAXLEN
 32

	)

18 
	#SESSION_ID_MAXLEN
 64

	)

19 
	#SESSION_PWD_MAXLEN
 32

	)

20 
	#SESSION_ADDR_MAXLEN
 100

	)

23 
	#SESSION_UPDATE_STATUS
 (0x1 << 1)

	)

24 
	#SESSION_UPDATE_LAST_TIME
 (0x1 << 2)

	)

25 
	#SESSION_UPDATE_SKEY
 (0x1 << 3)

	)

26 
	#SESSION_UPDATE_HOST
 (0x1 << 5)

	)

27 
	#SESSION_UPDATE_SC
 (0x1 << 6)

	)

28 
	#SESSION_UPDATE_CC
 (0x1 << 7)

	)

29 
	#SESSION_UPDATE_PORT
 (0x1 << 8)

	)

30 
	#SESSION_UPDATE_PEERADDR
 (0x1 << 9)

	)

31 
	#SESSION_UPDATE_SVR_IP
 (0x1 << 10)

	)

32 
	#SESSION_UPDATE_SVR_PORT
 (0x1 << 11)

	)

34 
	#SESSION_QUERY_BY_SID
 1

	)

35 
	#SESSION_QUERY_BY_UID_IP
 2

	)

36 
	#SESSION_QUERY_BY_UID
 3

	)

38 
	#SESSION_STATUS_VALIDING
 0

	)

39 
	#SESSION_STATUS_VALID
 1

	)

40 
	#SESSION_STATUS_FORCE_OUT
 2

	)

42 
	#ALG_SHA1
 1

	)

44 
	g£ssiÚ_hªdË_s
;

45 
£ssiÚ_hªdË_s
 *
	t£ssiÚ_hªdË
;

47 
	s£ssiÚ
 {

48 
	msid
;

49 
	m¡©us
;

50 
	mü—‹_time
;

51 
	mÏ¡_time
;

52 
	mskeyËn
;

53 
	mskey
[
SESSION_SKEY_MAXLEN
];

54 
	muid
;

55 
	m®Ÿs
[
SESSION_ID_MAXLEN
];

56 
	mÚlše
;

57 
	mho¡
[
SESSION_IP_MAXLEN
];

58 
	msc
;

59 
	mcc
;

60 
	mpÜt
;

61 
	m³”addr
[
SESSION_ADDR_MAXLEN
];

62 
	m³”addr_Ën
;

63 
	msvr_
[
SESSION_IP_MAXLEN
];

64 
	msvr_pÜt
;

65 } 
	t£ssiÚ_t
;

67 
	s£ssiÚ_cfg
 {

68 
	mho¡
[
SESSION_IP_MAXLEN
];

69 
	mpÜt
;

70 
	mu£ºame
[
SESSION_ID_MAXLEN
];

71 
	m·sswÜd
[
SESSION_PWD_MAXLEN
];

72 } 
	t£ssiÚ_cfg_t
;

74 
£ssiÚ_š™
(
£ssiÚ_hªdË
 *
phªdË
, cÚ¡ 
£ssiÚ_cfg_t
 *
cfg
, 
timeout
, 
®g
);

75 
£ssiÚ_add
(
£ssiÚ_hªdË
 
hªdË
, 
£ssiÚ_t
 *
d©a
);

76 
£ssiÚ_upd©e
(
£ssiÚ_hªdË
 
hªdË
, cÚ¡ 
£ssiÚ_t
 *
£ssiÚ
, 
æag
);

77 
£ssiÚ_qu”y
(
£ssiÚ_hªdË
 
hªdË
, 
£ssiÚ_t
 *
£ssiÚ
, 
æag
);

78 
£ssiÚ_d–‘e
(
£ssiÚ_hªdË
 
hªdË
, 
sid
);

79 
£ssiÚ_d–‘e_ex‹nd
(
£ssiÚ_hªdË
 
hªdË
, 
sid
, 
uid
);

80 
£ssiÚ_fÜû_out
(
£ssiÚ_hªdË
 
hªdË
, 
sid
, 
uid
);

81 
£ssiÚ_ş—n_timeout
(
£ssiÚ_hªdË
 
hªdË
, 
timeout
);

82 
£ssiÚ_ex™
(
£ssiÚ_hªdË
 
hªdË
);

83 
auth_£ssiÚ
(
£ssiÚ_hªdË
 
hªdË
, cÚ¡ *
sid
, 
time¡amp
,

84 
nÚû
, cÚ¡ *
sig
);

	@
1
.
0
2
17
main.c
session.h
